name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release to create'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - stable
      dry_run:
        description: 'Perform a dry run (no actual publishing)'
        required: false
        default: false
        type: boolean
      force_release:
        description:
          'Force a release even if no conventional commits warrant one'
        required: false
        default: false
        type: boolean
      version_bump:
        description: 'Version bump type (only used when force_release is true)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  validate:
    runs-on: pub-hk-ubuntu-24.04-ip
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install

      - name: Run linting
        run: pnpm run lint

      - name: Run type checking
        run: pnpm run type-check

      - name: Run tests
        run: pnpm test

  release-please:
    needs: validate
    if:
      ${{ github.ref_name == 'main' || github.event.inputs.release_type ==
      'beta' }}
    runs-on: pub-hk-ubuntu-24.04-ip
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      pr_number: ${{ steps.release.outputs.pr_number }}
      release_version: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Validate release type for branch
        if:
          github.event.inputs.release_type == 'stable' && github.ref_name !=
          'main'
        run: |
          echo "Error: Stable releases can only be created from main branch"
          exit 1

      - name: Review release-please inputs
        run: |
          echo "Force release: ${{ github.event.inputs.force_release }}"
          echo "Version bump: ${{ github.event.inputs.version_bump }}"
          echo "Release type: ${{ github.event.inputs.release_type }}"
          echo "Dry run: ${{ github.event.inputs.dry_run }}"
          echo "Release-as value: '${{ github.event.inputs.force_release == 'true' && github.event.inputs.version_bump || '' }}'"

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target-branch: ${{ github.ref_name }}
          config-file:
            release-please-config${{ github.event.inputs.release_type == 'beta'
            && '.beta' || '' }}.json
          manifest-file:
            .release-please-manifest${{ github.event.inputs.release_type ==
            'beta' && '.beta' || '' }}.json
          skip-github-pull-request: ${{ github.event.inputs.dry_run == 'true' }}
          release-as:
            ${{ github.event.inputs.force_release == 'true' &&
            github.event.inputs.version_bump || '' }}

      - name: Output release version
        run: |
          echo "Release type: ${{ github.event.inputs.release_type }}"
          echo "Release created: '${{ steps.release.outputs.release_created }}'"
          echo "Tag name: '${{ steps.release.outputs.tag_name }}'"
          echo "Release version: '${{ steps.release.outputs.tag_name }}'"
          echo "PR number: '${{ steps.release.outputs.pr_number }}'"
          echo "Upload URL: '${{ steps.release.outputs.upload_url }}'"
          echo "Version: '${{ steps.release.outputs.version }}'"

          # Check if any outputs are actually set
          if [ -z "${{ steps.release.outputs.release_created }}" ]; then
            echo "WARNING: release_created is empty - release-please may not have created a release"
          fi

  publish:
    needs: release-please
    runs-on: pub-hk-ubuntu-24.04-ip
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name || github.sha }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Enable Corepack
        run: corepack enable

      - name: Use latest pnpm version
        run: corepack use pnpm@latest-10

      - name: Install dependencies
        run: pnpm install

      - name: Debug force release
        if: ${{ github.event.inputs.force_release == 'true' }}
        run: |
          echo "Force release requested with version bump: ${{ github.event.inputs.version_bump }}"
          echo "Release type: ${{ github.event.inputs.release_type }}"
          echo "Release-please should handle versioning with release-as parameter"

      - name: Build package
        run: pnpm run build

      - name: Publish to npm
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN: Validating publish process..."
            if [ "${{ github.event.inputs.release_type }}" = "stable" ]; then
              pnpm publish --dry-run --provenance --no-git-checks
            else
              pnpm publish --dry-run --tag beta --provenance --no-git-checks
            fi
          else
            echo "Publishing version $(node -p "require('./package.json').version") to npm..."
            if [ "${{ github.event.inputs.release_type }}" = "stable" ]; then
              pnpm publish --provenance --no-git-checks
            else
              pnpm publish --tag beta --provenance --no-git-checks
            fi
            echo "Successfully published version $(node -p "require('./package.json').version")"
          fi
